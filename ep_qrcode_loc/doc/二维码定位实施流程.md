# 二维码定位系统实施流程

> 作者：袁勋     更新时间：2025.02.08



#### 出厂调试

##### 一、连接定位相机（海康-MV-SC2005AM-02WBN）

1. 连接电源和网线

2. 网口配置为固定IP：`192.168.7.8`，子网掩码：`255.255.255.0`

3. 安装客户端：`IDMVS-1.0.0_x86_64_20220926.deb`

4. 打开客户端连接相机，配置相机IP：`192.168.7.100`，子网掩码：`255.255.255.0`

5. 检查是否能够显示相机画面

6. 烧写固件：`单码digicap-2.7.0.dav`

7. 再次检查是否能够显示相机画面

8. 通信方式改为UDP，目标IP设置为网口IP：`192.168.7.8`，port: `1024`

9. 将配置保存未配置1，默认启动配置1，并重启相机确认是否保存成功

10. 将二维码放在相机正下方，能够识别出正确的信息

##### 二、相机安装与调平

1. 相机出线端朝向车身左侧或右侧，如遇阻碍，联系开发
2. 将车停在水平地面上
3. 使用水平仪检验相机安装是否水平
4. 通过增减螺丝垫片调节相机水平程度

##### 三、二维码定位程序安装与运行测试

1. 安装最新二维码定位程序：`ep-qrcode-loc-XXXXXXXXXXXX.deb`
2. 准备一个海康二维码，编号写进`/var/xmover/params/ep-qrcode-loc/SiteTable.txt`
3. 将二维码放在相机正下方
4. 最新pose文件中能够看到该二维码的相关数据：`/var/xmover/log/QR_code_loc/当前日期/pose.txt`

------

#### 现场实施

> 工具准备：50m钢卷尺、墨斗、激光水平仪；

##### 一、调试堆叠取卸货

1. 建图，测试建图质量（有无跳变）
2. 在水平地面上，机械方法将货叉调平
3. 调整底层参数中上下拉绳编码器的补偿值，使货叉底部高度与输出高度保持一致
4. 将运动控制中堆叠补偿参数归为初值，包括：
    - `to_battery_dis` = 货叉缩回后，其根部到后轮中心的距离
    - `forward_length` = 0.0
    - `change_dis` = 0.25
5. 将stacking程序中取卸货横向和纵向的补偿归零
6. 工程师端中设置库位模型，宽度和深度与载具尺寸保持一致
7. 创建库位和路线，库位精确定位的方法可以采用：
    - 载具放在预定位置，后轮顶着载具
    - 使用车的位姿创建站点
    - 根据`后轮中心到后边缘的距离`和`载具深度`阵列得到位置精确的库位
8. 分别调试一层取卸货，以及二、三层取卸货

    - 石花：卸货只使用down，一层取货down，二三层取货top
##### 二、规划库位

1. 检查现场是否方正，可用激光水平仪

2. 测量现场尺寸、载具尺寸、车宽、后轮中心到车头距离、后轮中心到叉尖距离

3. 问清楚客户对于载具堆叠的规划和要求，包括出入库先后顺序的规划

4. 根据实际情况确定堆放间距（湖北石花左右0.17m，前后0.14m），需要保证：
    - 车身可以在列首完成自旋

    - 倒车过程中车身和所带货物不蹭到两边堆放的货物

##### 三、规划和粘贴二维码

*注意：列首不遮挡雷达的区域**不粘贴**二维码，该区域用于AGV自旋后进行横向位置调整*

1. 使用墨斗弹出列首、列尾横向基准线（石花：以两侧承重柱为基准）
2. 计算每列二维码纵向基准线位置，在上述两个横向基准线上标记出来，根据：
    - 列中心线位置
    - 相机在base_link中的横向偏差

3. 对上一步标记的位置进行校验，确保无误
4. 墨斗弹出每列二维码纵向基准线
5. 确定与库位绑定的二维码相对于库位的纵向坐标，根据：
    - 库位深度
    - 识别点位置（与货叉长度，进出分支中动作点距离）
    - 货叉动作点位置（最终停车的位置，与change_dis相关）
    - 辅助点位置（在上述两个点中间，减小递推距离）
    - 相机相对于base_link的位置
6. 计算每排二维码横向基准线位置，在最边上的两个纵向基准线上标记出来
7. 对上一步标记的位置进行校验，确保无误
8. 墨斗弹出每排二维码横向基准线
9. 粘贴二维码，与十字交叉基准线对齐，码方向与库位方向相同



##### 四、调试二维码定位程序参数

1. 关闭monitor程序对二维码定位程序的监测
2. 采集每列二维码编号
    1. 进入模式2，重启二维码定位程序
    2. 手动模式，从列尾到列首，用相机依次扫过该列所有二维码
    3. 扫到的二维码编号记录在：`/var/xmover/log/QR_code_loc/当前日期/当前时间_qrcode_log.txt`
    4. 按照格式和顺序要求填写`SiteTable.scv`文件，列首库位位姿先不管
    5. 依次采集每列二维码编号
    6. 将`SiteTable.scv`文件重命名为`SiteTable.txt`，放在`/var/xmover/params/ep-qrcode-loc/`
3. 找到库位中轴线（使用雷达定位）
    1. 进入模式4（测试模式，只输出二维码得到的定位值，不使用轮速计递推）
    2. 在每列的位置规划出一条直线（速度0.4），调整起点和终点，使车在前进的过程中，二维码在相机视野中央
    3. 路线方向可作为列首库位方向角，路线作为本列库位中轴线
4. 校正相机方向角（使用雷达定位）
    1. 进入模式5（采集角度模式），重启二维码定位程序
    2. 车走直线采集一列码的数据（车身初始位置和方向摆正，尽可能减小启动时车身方向的偏转）
    3. 打开文件：`/var/xmover/log/QR_code_loc/yawerr.txt`
    4. 计算地码方向角均值与路线方向角的差值（格式改成csv，用excel打开），补偿到相机方向角上（tf参数）
    5. 重复第1步，检查相机方向角是否补偿到位
5. 补偿地码方向角偏差（使用雷达定位）
    - 删除`yawerr.txt`
    - 在每一列用模式5采集数据，每次完成后关闭二维码定位程序，每列3次
    - 进入模式6（计算角度模式），生成`SiteTable_output.txt`后关闭二维码定位程序，使用该文件替换`SiteTable.txt`
6. 补偿舵轮方向角偏差（使用雷达定位）
    - 关闭二维码定位程序
    - 打开plotjuggler：`rosrun plotjuggler plotjuggler`
    - 订阅：/real_vel，实时绘制：angular.y（舵轮的实际角度）
    - 车走一条尽可能长的直线
    - 车身方向角稳定后，计算舵轮偏转角的平均值，写到参数：
        - wheel_angular_forward: 0.0  # 主动轮前进零位偏移，单位：度
        - wheel_angular_backward: 0.0  # 主动轮后退零位偏移，单位：度
7. 确定列首库位位姿（使用雷达定位）
    - 将相机放在第一个非列首地码正上方，车身方向与库位方向尽可能一致，停稳
    - 进入模式1（采集二维码坐标），重启二维码定位程序，几秒钟后`CaptureTable.txt`中增加该二维码的位姿
    - 关闭二维码定位程序
    - 重复以上操作，采集每列的第一个非列首地码和列尾地码在map中的坐标
    - 在工程师端根据地码位姿创建站点，路线方向作为列方向角，使用阵列的方法验证列方向角，并微调
    - 根据第一个非列首地码与列首库位的变换关系确定列首库位位姿，记入`SiteTable.txt`文件
    - 阵列得到本列其它库位
8. 开启monitor程序对二维码定位程序的监测
9. 进入模式3（正常模式），重启二维码定位程序，测试使用二维码定位进出列

------

#### 后期维护

##### 一、单个二维码维护与更换

###### 1、清理地面，粘贴新二维码

1）二维码需要更换的情况：核心矩阵损坏，或者污渍无法清除

2）用铲刀和抹布清理损坏二维码，保证新二维码能够与地面完全贴合

3）用抹布或者扫帚清理附近地面，保证亚克力板能贴合地面

4）使用亚克力板和地面墨线将二维码粘贴到准确位置，优先保证二维码的方向角

###### 2、调试新二维码方向角补偿值

> 使用4号车，参数文件路径：`/var/xmover/params/ep-qrcode-loc/SiteTable.txt`

1）备份参数文件

2）根据列数、排数、旁边二维码编号等信息，确定更改位置

3）更新二维码编号，对应方向角补偿值改为0

4）重启二维码定位程序（通过参数服务器）

5）将AGV停到列内，距离新二维码较远的地方，车身摆正，相机正对某个二维码

6）手动触发任务使AGV相机扫过新二维码

7）打开跳变记录文件，根据新二维码编号找到对应数据条目

> 文件路径：`/var/xmover/log/QR_code_loc/当前日期/jumperr.txt`
>
> 条目解析：时间、二维码编号、x轴偏差、y轴偏差、方向角偏差、......

8）观察新二维码条目中y轴偏差和方向角偏差，与前后若干条目相比是否过大，如果水平相当，则方向角补偿值调试完成，否则继续步骤9

9）根据方向角偏差微调SiteTable.txt中的方向角补偿，每次增加或减小0.1

10）重启二维码定位程序，并回到步骤5，重新采集跳变数据

###### 3、将新二维码的信息更新到其它AGV

- 参数文件路径：`/var/xmover/params/ep-qrcode-loc/SiteTable.txt`
- 信息包含编号、方向角补偿值
- 更新后，需重启AGV

#### 其他

- 舵轮零位尽可能调节精准，使用使用柯蒂斯手持器，或者其它设备器
- 扫码后，倒车10cm停车识别
- 尽可能将货物与货物、货物与墙之间的间隙宽度平均分配
